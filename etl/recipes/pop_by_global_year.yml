# in this recipe:
# bridged datapoints for global-year for UN WPP and Gapminder historic population
#
# Note: global data for gapminder is calculated by suming all countries' data

info:
    id: pop_by_global_year
    base:
        - &un_pop open-numbers/ddf--unpop--world_population_prospects
        - &gm_geo open-numbers/ddf--gapminder--geo_entity_domain

config:
    recipes_dir: ./

ingredients:

    - id: unpop-datapoints-pop-by-global
      dataset: *un_pop
      key: global, time
      value:
          - population

    - id: unpop-datapoints-pop-by-global-age
      dataset: *un_pop
      key: global, time, age1yearinterval
      value:
          - population

    - id: unpop-datapoints-pop-by-global-age-gender
      dataset: *un_pop
      key: global, time, age1yearinterval, gender
      value:
          - population

cooking:
    datapoints:
        - procedure: run_op
          ingredients:
              - unpop-datapoints-pop-by-global
          options:
              op:
                  population: population * 1000
          result: unpop-datapoints-pop-by-global-thousands

        - procedure: run_op
          ingredients:
              - unpop-datapoints-pop-by-global-age
          options:
              op:
                  population: population * 1000
          result: unpop-datapoints-pop-by-global-age-thousands

        - procedure: run_op
          ingredients:
              - unpop-datapoints-pop-by-global-age-gender
          options:
              op:
                  population: population * 1000
          result: unpop-datapoints-pop-by-global-age-gender-thousands


        # global pop by global
        - procedure: translate_header
          ingredients:
              - unpop-datapoints-pop-by-global-thousands
          options:
              dictionary:
                  time: year
          result: unpop-datapoints-pop-by-global-thousands-year

        - procedure: translate_column
          ingredients:
              - unpop-datapoints-pop-by-global-thousands-year
          options:
              column: global
              dictionary:
                  '900': world
          result: &byglobal unpop-datapoints-pop-by-global-translated

        # global pop by global, age
        - procedure: translate_header
          ingredients:
              - unpop-datapoints-pop-by-global-age-thousands
          options:
              dictionary:
                  age1yearinterval: age
                  time: year
          result: unpop-datapoints-pop-by-global-age-thousands-translated

        - procedure: translate_column
          ingredients:
              - unpop-datapoints-pop-by-global-age-thousands-translated
          options:
              column: global
              dictionary:
                  '900': world
          result: &byage unpop-datapoints-pop-by-global-age-translated

        # by age-gender
        - procedure: translate_header
          ingredients:
              - unpop-datapoints-pop-by-global-age-gender-thousands
          options:
              dictionary:
                  age1yearinterval: age
                  time: year
          result: unpop-datapoints-pop-by-global-age-gender-thousands-translated

        - procedure: translate_column
          ingredients:
              - unpop-datapoints-pop-by-global-age-gender-thousands-translated
          options:
              column: global
              dictionary:
                  '900': world
          result: &byagegender unpop-datapoints-pop-by-global-age-gender-translated

        - procedure: serve
          ingredients:
              # - *bridged
              - *byglobal
              - *byage
              - *byagegender
